{{define "layout"}}
<!DOCTYPE html>
<html>

<head>


</head>

<body>
    {{.}}

    {{ end }}
    {{ template "head"}}
</body>

<body id="stand" style="overflow: hidden;height: 100%;">
    <title>看板项目详细信息</title>
    <div class="wd_body_look">
        <div>
            <!-- 名称。成员和设置 -->
            <div style="display: inline-block;margin: 5px;">
                <div class="stand_look" id="stand_name">
                    <h4 class="stand_look_hfour" onclick="kanbantask()">{{.project_name}}</h4>
                    <p class="stand_note" title="{{.project_note}}">项目备注:{{.project_note}}</p>
                </div>
            </div>
            <!-- 项目备注 -->

            <div class="stand-look-setpro" id="look_setpro" onclick="kanban_set()"
                style="cursor: pointer;display: none;">
            </div>
            <a href="#look_setpro" class="stand-look-setpro" style="float: right;cursor: pointer;">
                <div class="stand-look-set">
                    设置
                </div>
                <div class="stand-look-setting">
                    <img style="width: 22px;" src="/img/setgreen.png">
                </div>
            </a>

            <div class="stand-look-user" id="look_user" style="float: right;cursor: pointer;display: none;"
                onclick="kanban_mmb()">
            </div>
            <a href="#look_user" class="stand-look-user" style="cursor: pointer;">
                <div class="stand-look-mmber">
                    成员
                </div>
                <div class="stand-look-member">
                    <h3>{{.project_member}}</h3>
                </div>
            </a>

            <div style="clear: both;">
                <hr>
            </div>
            <div id="kanban_wd" style="	overflow-y: hidden;">
                <div id="taskform" style="padding-top: 10px;">
                    <div id="task_form_qingdan" class="task_form_qingdan" style="padding-bottom: 8px;">

                    </div>


                </div>


            </div>

            <div style="display: none;" class="k_d_all_wd">

            </div>

        </div>


        <!-- 名称。成员和设置 -->
        <form style="display: none;" id="mmbform" onsubmit="return false" method="post">
            <div class="kanban_mmb">
                <div>
                    <div class="kanban_mmber_all">
                        <div>
                            <div style="padding-top: 10px;">
                                项目创建者
                            </div>
                            <div class="kanban_mmb_user">

                            </div>
                        </div>
                        <div>
                            <div style="padding-top: 10px;">
                                项目成员
                            </div>
                            <div class="kanban_mmb_member">

                            </div>
                        </div>
                    </div>
                    <div>
                        <hr>
                    </div>
                    <div class="kanban_member_body_member" style="padding-bottom: 10px;">

                    </div>
                </div>
            </div>
        </form>
        <form style="display: none;" id="setform" onsubmit="return false" method="post">
            <!-- 设置页面 -->
            <div class="stand-set">
                <div>
                    <input type="hidden" value="{{.project_gid}}" name="id">
                </div>
                <!-- 设置的项目名称 -->
                <div class="stand-set-user">
                    <div>
                        <input type="text" name="name" value="{{.project_name}}">
                    </div>
                </div>
                <!-- 设置的项目备注 -->
                <div class="stand-set-note" style="margin-top: -10px;">
                    <div>
                        <textarea name="note" maxlength="121" placeholder="项目备注：">{{.project_note}}</textarea>
                    </div>
                </div>
                <!-- 设置的项目类型 -->
                <div class="stand-set-type">
                    <div>
                        <div>项目类型</div>
                        <div>
                            <div class="stand-set-borad">
                                <input id="stand-set-radio" type="radio" name="type" value="2">
                            </div>
                            <div class="stand-set-pro">
                                <div>
                                    <label for="stand-set-radio">标准项目</label>
                                </div>
                                <div>
                                    更好地组织、细分和管理任务，适用于一般项目管理
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="stand-set-borad">
                                <input id="stand-set-radio-look" type="radio" value="1" name="type" checked="checked">
                            </div>
                            <div class="stand-set-pro">
                                <div>
                                    <label for="stand-set-radio-look">看板项目</label>
                                </div>
                                <div>
                                    擅长处理流程化任务，适用于产品研发、用户支持等场景
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="stand-set-hr">
                    <hr>
                </div>
                <!-- 项目成员 -->
                <div>
                    <div class="stand-set-mmber">
                        <div style="color: rgb(85, 85, 85);">项目成员</div>
                        <div>
                            <input id="stand_mmber" checked="checked" type="checkbox" maxlength="15">
                        </div>
                        <div>
                            <label for="stand_mmber" style="color: rgb(85, 85, 85);">所有人</label>
                        </div>
                    </div>
                    <div class="stand-set-member" id="stand-set-mmb">

                    </div>
                </div>
                <!-- 未选中成员 -->
                <div class="stand-unxuan-mmber" style="margin-left: 25px;">
                    <div style="color: #aeaaaa;font-size: 12px;">添加未选中成员</div>
                    <div class="stand-set-unmmber">

                    </div>
                </div>

                <div>
                    <div style="color: #aeaaaa;font-size: 11px;margin: 10px;margin-left: 25px;">
                        添加标签 (<label style="color: red;">注</label>：输入的标签内容在 <strong>6</strong>个字之内)
                    </div>
                    <div>
                        <div style="color:rgb(85, 85, 85);font-size: 12px;margin: 10px;margin-left: 25px;">
                            系统标签
                        </div>
                        <div>
                            <div class="wd_project_system"
                                style="min-width: 70px;height: 25px;line-height: 25px;border-radius: 5px;clear: both;float: left;margin-left: 25px;">
                                <div style="text-align: center;"><input type="text" value='<BUG>' name="tag"
                                        readonly="readonly"
                                        style="font-size: 14px;color: white;width: 70px;font-size: 13px;border: 0;border-radius: 5px;background: none;text-align: center;">
                                </div>
                            </div>
                            <div class="wd_project_system_yanchi"
                                style="min-width: 70px;height: 25px;line-height: 25px;border-radius: 5px;float: left;">
                                <div style="text-align: center;"><input type="text" value="<延迟>" name="tag"
                                        readonly="readonly"
                                        style="font-size: 14px;color: white;width: 70px;color: white;font-size: 13px;border: 0;border-radius: 5px;background: none;text-align: center;">
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 自定义标签 -->
                    <div style="clear: both;">
                        <div
                            style="font-size: 12px;margin-top: 10px;clear: both;margin-left: 25px;padding-top: 10px;color: rgb(85, 85, 85);">
                            自定义标签
                        </div>
                        <div class="wd_kanban_zidingyi"
                            style="float: left;font-size: 12px;margin-left: 24px;margin-top: 2px;line-height: 2;cursor: pointer;">
                            <div class="wd_kanban_add" style="margin: 5px;float: left;">
                                <div class="" style="display: inline;" onclick="add_kan()">添加</div>
                            </div>

                        </div>
                    </div>
                    <!-- 按钮 -->
                    <div style="clear: both;margin-top: 15px;padding-top: 10px;">
                        <hr>
                    </div>

                    <div>
                        <div class="kanban_submint_set">
                            <input type="submit" value="保存设置" onclick="kanbanset()" name="" id="">
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

</body>
<script>
    $(function () {
        $(window).resize(function () {
            var winHeight = $(window).height();
            
            $('.k_d_all_wd').css({
                'height':winHeight - 200
            })
            $('.wd_kanban_taskqingdan').css({
                'height':winHeight - 249
            })
            $('#kanban_wd').css({
                'height':winHeight - 218
            })
        })
       
    })
    $(document).ready(function(){
        var winHeight = $(window).height(); 
            $('#kanban_wd').css({
                'height':winHeight - 218
            })
            $('#taskform').css({
                'height':winHeight - 235
            })
            $('.k_d_all_wd').css({
                'height':winHeight - 200
            })
            $('.wd_kanban_taskqingdan').css({
                'height':winHeight - 200
            })
    })
    function kanbanaddqingdan() {
        var rrr = new Array();
        let serial = $('.wd_kanban_serial');
        for (i = 0; i < serial.length; i++) {
            let tmpser = serial[i].getAttribute('value')
            rrr.push(tmpser)
        }
        var max = rrr.sort(function (a, b) {
            return b - a;
        })[0];
        // console.log(max)
        let max_ser = ++max
        let shuru = '<div class="kanban_shuru">' +
            '<div>' +
            '<input type="hidden"  name="pid" value="{{.project_gid}}" id="">' +
            '<input type="hidden" id="kanban_serial"  name="serial" value="' + max_ser + '" id="">' +
            '<input type="text" placeholder="输入清单名称" name="name" id="wd_kanbanqingdan_val">' +
            '</div>' +
            '<div style="margin-top: 10px;">' +
            '<input type="submit" onclick="addqingdan()" value="创建清单">' +
            '</div>' +
            '<div style="margin-top: 10px;">' +
            '<input style="background: none;color: black;" onclick="kanban_wd_quxiao()" type="submit" value="取消">' +
            '</div>' +
            '</div>'
        $('.wd_kanban_add_qingdan').html(shuru).css('height', '100px').hide().fadeIn()
    }
    function kanban_wd_quxiao() {
        let add = ' <div class="kanban_add_qingdan" onclick="kanbanaddqingdan()">' +
            '<div style="display: inline;position: relative;top: 25%;">' +
            '<img src="/img/kanban/u13.png" alt="">' +
            '</div>' +
            '<div style="display: inline;position: relative;top: 25%;margin-left: 3px;">' +
            '添加新清单' +
            '</div>' +
            '</div>'
        $('.wd_kanban_add_qingdan').html(add).css('height', '60px').hide().fadeIn()
    }
    function kanbantask() {
        beacon_reset()
    }
    //重置接口数据
    function beacon_reset() {
        var stateObj = { foo: 'bar' };
        history.pushState(stateObj, null, '{{.project_gid}}');
        $('.task_form_qingdan').html('')
        $('.k_d_all_wd').html('')
        task_beacon()

        $('#setform').hide();
        $('#mmbform').hide();
        $('#kanban_wd').show();
        $('.wd_body_look').css({
            'width': '100%'
        })

        k_set()
        k_mmb()
        $('.stand-look-user').css({
            'color': 'rgb(85, 85, 85)'
        })
        $('.stand_look_hfour').css({
            'color': 'black'
        })
        $('.stand_look_hfour').hover(function () {
            $('.stand_look_hfour').css({
                'color': 'black'
            })
        }, function () {
            $('.stand_look_hfour').css({
                'color': 'black'
            })
        })
    }
    function kanban_set() {
        $('#setform').show();
        $('#mmbform').hide();
        $('#kanban_wd').hide();
        $('.wd_body_look').css({
            'width': '1200px'
        })
        $('.stand-look-setpro').css({
            'color': 'black'
        })
        $('.stand-look-setpro img').css({
            'opacity': '1',
            'filter': 'brightness(0%)'
        })
        k_task()
        k_mmb()
        $('.stand-look-user').css({
            'color': 'rgb(85, 85, 85)'
        })
        $('.stand-look-setpro').hover(function () {
            $('.stand-look-setting img').css({
                'opacity': '1',
                'filter': 'brightness(0%)'
            })
            $('.stand-look-setpro').css({
                'color': 'black'
            })
        })
        $('.stand_look_hfour').css({
            'color': 'rgb(85, 85, 85)'
        })
        $('.stand_look_hfour').hover(function () {
            $('.stand_look_hfour').css({
                'color': '#339966'
            })
        }, function () {
            $('.stand_look_hfour').css({

                'color': 'rgb(85, 85, 85)'
            })
        })
    }
    function kanban_mmb() {
        $('#mmbform').show();
        $('#setform').hide();
        $('#kanban_wd').hide();
        $('.wd_body_look').css({
            'width': '1200px'
        })

        k_set()
        k_task()
        $('.stand-look-setpro').css({
            'color': 'rgb(85, 85, 85)'
        })
        $('.stand-look-user').css({
            'color': 'black'
        })
        $('.stand-look-user').hover(function () {
            $('.stand-look-user').css({
                'color': 'black'
            })
        }, function () {
            $('.stand-look-user').css({
                'color': 'black'
            })
        });
    }
    function k_set() {
        $('.stand-look-setting img').css({
            'opacity': '0.5',
            'filter': 'brightness(20%)'
        })
        $('.stand-look-setpro').css({
            'color': 'rgb(85, 85, 85)'
        })
        $('.stand-look-setpro').hover(function () {
            $('.stand-look-setting img').css({
                'opacity': '1',
                'filter': 'brightness(100%)'
            })
            $('.stand-look-setpro').css({
                'color': '#339966'
            })
        }, function () {
            $('.stand-look-setting img').css({
                'opacity': '0.5',
                'filter': 'brightness(20%)'
            })
            $('.stand-look-setpro').css({
                'color': 'rgb(85, 85, 85)'
            })
        });
    }
    function k_mmb() {
        $('.stand-look-user').hover(function () {
            $('.stand-look-user').css({
                'color': '#339966'
            })
        }, function () {
            $('.stand-look-user').css({
                'color': 'rgb(85, 85, 85)'
            })
        })

        $('.stand_look_hfour').hover(function () {
            $('.stand_look_hfour').css({
                'color': 'rgb(85, 85, 85)'
            })
        }, function () {
            $('.stand_look_hfour').css({
                'color': 'rgb(85, 85, 85)'
            })
        })
        $('.stand_look_hfour').css({
            'color': 'rgb(85, 85, 85)'
        })
    }
    function k_task() {
        $('.stand_look_hfour').hover(function () {

            $('.stand_look_hfour').css({
                'color': '#339966'
            })
        }, function () {
            $('.stand_look_hfour').css({
                'color': 'rgb(85, 85, 85)'
            })
        })
    }
    let tongjiarr = []; //这个是成员的个数数组
    let member = [];
    let memberall = [];

    let kanadduser = [];
    let kanallper = [];
    let kanalltag = [];
    function kanbanHash() {
        var hash = window.location.hash;
        switch (hash) {
            case '#look_user':
                kanban_mmb()
                break;
            case '#look_setpro':
                kanban_set()
                break;
            default:
        }
    }
    $(document).ready(function () {
        $('.stand-look-user').click(function () {
            kanban_mmb()
        })
        $('.stand-look-setpro').click(function () {
            kanban_set()
        })
        window.onhashchange = kanbanHash();
        $.ajax({
            url: "/project/member/{{.project_gid}}",
            async: false,
            type: "GET",
            success: function (data, result, testStatus) {
                let mmmuser = decodeURIComponent(data.data.mmb_user).replace(/{/g, '')
                let mmbobj = mmmuser.replace(/}/g, '')
                if (decodeURIComponent(data.data.mmb_user) != '{}') {
                    var obj = JSON.parse(decodeURIComponent(data.data.mmb_user)).map(item => {
                        let itemKey = Object.keys(item)[0];
                        return {
                            gid: itemKey,
                            name: item[itemKey]
                        };
                    });
                    for (i = 0; i < obj.length; i++) {
                        let gid = decodeURIComponent(obj[i].gid);
                        let name = decodeURIComponent(obj[i].name);
                        $('.stand-set-member').append('<div class="stand_set_mmb"><input id="stand-set-cbx' + i + '" name="user" class="stand-set-cbx" type="checkbox" checked value="' + gid + '">' +
                            '<input style="display:none;" class="wd_pro_ttmp" id="wd_pro_tmp' + i + '" name="user" type="checkbox" value="1">' +
                            '<label style="color: rgb(85, 85, 85);" for="stand-set-cbx' + i + '">' + name + '</label></div>')

                        group1 = decodeURIComponent(JSON.stringify(obj));
                        // let tmp = '{"id":"'+gid+'","name":"'+name+'"}'
                        // member.push(obj)
                        tongjiarr.push(gid)//统计成员数量
                        $('.kanban_mmb_member').append('<a style="padding-right: 10px;" href="/team/member/' + gid + '">' + name + '</a>').css('margin-top', '10px') //项目成员添加
                        $('#stand_mmber').click(function () {
                            if (this.checked) {
                                $('.stand-set-cbx').prop('checked', true)
                            } else {
                                $('.stand-set-cbx').prop('checked', false)
                            }
                        })
                        standcbx(i)
                        kanadduser.push(gid + ',' + name)
                    }
                } else {
                    group1 = '';
                    $('.stand-set-member').append('');
                }


                let objadd = decodeURIComponent(data.data.add_user);
                objadd = JSON.parse(objadd);
                for (k in objadd) {
                    let name = decodeURIComponent(objadd[k])
                    let username = k;
                    mmber = k;
                    mmber_name = name;
                    group3 = decodeURIComponent(data.data.add_user);

                    tongjiarr.push(mmber) //统计成员数量
                    $('.kanban_mmb_user').html('<a href="/team/member/' + mmber + '">' + mmber_name + '</a>').css('margin-top', '10px') // 项目创建者添加
                    kanadduser.push(mmber + ',' + mmber_name)
                }
            },
            error: function (xhr, errorMessage, e) {
                alert("系统异常");
            }
        })
        $.ajax({
            url: "/member/all",
            async: false,
            type: "GET",
            data: $('#form2').serialize(),
            success: function (data, result, testStatus) {

                if (data && data.data && data.data.length) {

                    var pdata = data.data.map(item => {

                        // data.data.map(item=>`'${item}'`).join();
                        let itemKey = Object.keys(item)[0];//注释
                        // var d =JSON.stringify(pdata);
                        return {
                            gid: itemKey,
                            name: item[itemKey]
                        }
                    })
                    let all = [];
                    for (var i = 0; i < pdata.length; i++) {
                        // var bbb = decodeURIComponent([pdata[i].gid])
                        all_id = pdata[i].gid
                        all_name = decodeURIComponent(pdata[i].name)

                        // let tmp = '{"id":"'+all_id+'","name":"'+all_name+'"}'
                        // memberall.push(pdata)
                        kanallper.push(all_id + ',' + all_name)
                        group2 = decodeURIComponent(JSON.stringify(pdata));
                    }
                }
            },
            error: function (xhr, errorMessage, e) {
                alert("系统异常");
            }
        })
        $.ajax({
            url: "/project/tag/{{.project_gid}}",
            async: false,
            type: "GET",
            success: function (data, result, testStatus) {
                let task_tag = decodeURIComponent(data.data)
                let stand_tag = task_tag.split(',');
                for (i = 0; i < stand_tag.length; i++) {
                    let tag = '<div id="wd_project_custom' + i + '" class="wd_project_custom" style="min-width: 100px;height: 25px;line-height: 27px;border-radius: 5px;float: left;margin-top: 5px;">' +
                        '<div>' +
                        '<input id="wd_project_inputtag' + i + '" readonly="readonly" type="text" name="tag" maxlength="6" value="' + stand_tag[i].replace(/\+/g, ' ') + '" style="cursor: default;font-size: 14px;color: white;line-height: 21px;height:15px;background: 0;border: 0;text-align: center;width: 67px;">' +
                        '<i class="wd_project_system_i" style="margin-top: -2px;float: right;cursor: pointer;">x</i>' +
                        '</div>' +
                        '</div>'
                    $('.wd_kanban_add').before(tag)
                    kanalltag.push(stand_tag[i])
                    if (stand_tag[i] == '<BUG>' || stand_tag[i] == '<延迟>') {
                        $('#wd_project_custom' + i).remove();

                    }
                    if ($('#tag_set' + i).val() == $('#tag_seting').val()) {
                        $('.tag_name' + i).remove();

                    }
                    if ($('#wd_project_inputtag' + i).val() == '' || $('#wd_project_inputtag' + i).val() == ' ') {
                        $('#wd_project_custom' + i).remove();

                    }
                }
            },
            error: function (xhr, errorMessage, e) {
                alert("系统异常");
            }
        })
        $.ajax({
            url: "/project/log/{{.project_gid}}",
            async: false,
            type: "GET",
            success: function (data, msg, testStatus, result) {

                if (data.state == 0){
                    layer.msg(data.msg)
                }else{
                    let log_tmp = decodeURIComponent(data.data)
                    let log_obj = JSON.parse(log_tmp)
                    
                    if (log_obj != null) {
                        for (i = 0; i < log_obj.length; i++) {
                            let addtime = log_obj[i].add_time;

                            let content = log_obj[i].content;

                            let cont = decodeURIComponent(content.replace(/\+/g, ''));
                            let cnn = cont.split(':')[1];
                            let cxn = cnn.split('}')[0];
                            let cvv = cxn.replace('"', ' ');
                            let cff = cvv.replace('"', ' ');
                            $('.kanban_member_body_member').append(
                                '<div id="detail_log_mmb" class="detail_mmb' + i + '">' +
                                '<div id="detail_member_body_memberchang" class="detail_member' + i + '">' + '</div>' +
                                '<div id="detail_member_body_recording" class="detail_member_body' + i + '">' +
                                '<div style="display: inline;">' + ShowTime(decodeURIComponent(addtime)) + '</div>' +
                                '<div style="display: inline;">' +
                                '<label>' + cff + '</label>' +
                                '</div>' +

                                '</div>' +
                                '</div>'
                            )
                        }
                    } else {
                        $('.kanban_member_body_member').append(
                            '<div id="detail_log_mmb_else" class="detail_mmb">' +
                            '项目变更日志为空' +
                            '</div>'
                        )
                    }
                }
                


            },
            error: function (xhr, errorMessage, e) {
                alert("系统异常");
            }
        })
        task_beacon()
        kanbanbijiao(group1, group2, group3, tongjiarr)
    })

    function standcbx(i) {

        let qrr = $('.stand_set_mmb .stand-set-cbx');
        qrr.prop('checked', true)
        $('#stand-set-cbx' + i).click(function () {
            if (this.checked) {
                $('#wd_pro_tmp' + i).val('1')
            } else {
                $('#wd_pro_tmp' + i).val('0')
            }
            paintos()
        })
        $('#stand_mmber').click(function () {
            if (this.checked) {
                $('#wd_pro_tmp' + i).val('1')
            } else {
                $('#wd_pro_tmp' + i).val('0')
            }
        })

    }
    function paintos() {
        var rrr = new Array();
        let arr = $('.stand_set_mmb  .wd_pro_ttmp');
        for (let j = 0; j < arr.length; j++) {
            rrr.push(arr[j].getAttribute('value'));
        }
        let index = rrr.indexOf('0');
        if (index == -1) {
            $('#stand_mmber').prop('checked', true)
        } else {
            $('#stand_mmber').prop('checked', false)
        }
        return index
    }
    function kanbanbijiao(group1, group2, group3, tongjiarr) {
        $('.stand-look-member h3').html(tongjiarr.length)
        let a = JSON.parse(group1)
        let b = JSON.parse(group2)
        let c = [];
        let d = [];
        for (let i = 0; i < b.length; i++) {
            let ok = true;

            for (let j = 0; j < a.length; j++) {
                if (a[j].gid == b[i].gid) {
                    ok = false;
                }
            }
            if (ok) {
                c.push(b[i]);
            }
        }
        let ad = JSON.parse(group3)
        for (let i = 0; i < c.length; i++) {

            let ok = true;
            for (k in ad) {

                if (k == c[i].gid) {
                    ok = false;
                }
            }
            if (ok) {
                d.push(c[i]);
            }
        }
        addweixuan(d)
    }
    function addweixuan(d) {
        for (i = 0; i < d.length; i++) {
            let id = d[i].gid;
            let name = d[i].name;

            $('.stand-set-unmmber').append('<div class="stand_kanban_wei"><input id="stand_wei' + i + '" name="user" class="stand-kanban-cbx" type="checkbox" value="' + id + '">' +
                '<input style="display:none;" class="wd_pro_ttmp" id="wd_pro_tmp' + i + '" name="user" type="checkbox" value="1">' +
                '<label style="color: rgb(85, 85, 85);font-size: 12px;margin-left: 4px;" for="stand_wei' + i + '">' + name + '</label></div>')
        }
    }
    // 任务详情页面下关闭按钮
    function k_d_view_close(task_id) {
        var stateObj = { foo: 'bar' };
        history.pushState(stateObj, null, '{{.project_gid}}');
        homeview(task_id)
        $('#k_d_div' + task_id).hide();
        $('#kanban_wd').show();
        $('#d_tasksub_mo' + task_id).hide();
        $('.k_d_all_wd').hide();
    }
    function kanbanset() {
        let data = [];//定义一个空数组
        let str = $('#setform').serialize();//提取form1里面的所有数据
        let arr = str.split("&");//切割&
        let user = [];//定义空数组
        let tag = [];
        let length = arr.length;//定义arr的长度
        for (let i = 0; i < length; i++) {//for循环
            let tmp = arr[i].split("=");//定义tmp，切割arr[i]的'='
            if (tmp[0] == 'user') {//如果tmp等于user，
                user.push(tmp[1]);//push下标
            } else if (tmp[0] == 'tag') {
                tag.push(tmp[1]);
            } else {
                data.push(arr[i]);
            }
        }
        if (user == '') {
            data.push("user=");
        } else {
            data.push("user='" + user.join("','") + "'");
        }
        if (tag == '') {
            data.push("tag=");
        } else {
            data.push("tag=" + tag.join(",") + "");
        }
        data = data.join('&');
        $.ajax({
            url: "/project/set_submit",
            async: false,
            type: "post",
            data: data,
            success: function (result, testStatus) {
                if (result.state == 0) {
                    layer.msg(result.msg)
                } else if (result.state == 1) {
                    layer.msg('正在保存设置...')
                    setTimeout(function () {
                        layer.msg(result.msg)
                    }, 900);
                    setTimeout(function () {
                        window.location.reload();
                    }, 1500);
                }
            },
            error: function (xhr, errorMessage, e) {
                alert("系统异常");
            }
        })
    }
    // 添加任务清单
    function addqingdan() {
        $.ajax({
            url: "/task/class_add",
            async: false,
            type: "post",
            data: $('#add_qingdan').serialize(),
            success: function (result, testStatus, data) {

                if (result.state == 0) {
                    layer.msg(result.msg)
                } else if (result.state == 1) {
                    let id = data.responseJSON.data;
                    let name = $('#wd_kanbanqingdan_val').val();

                    let state = '1'
                    let task = [];
                    let serial = $('#kanban_serial').val()
                    let e_ggid = '{{.project_gid}}'
                    addtaskqingdan(id, name, state, task, kanadduser, kanallper, kanalltag, serial,e_ggid)
                    $('#wd_kanbanqingdan_val').val('')
                    kanban_wd_quxiao()
                }
            },
            error: function (xhr, errorMessage, e) {
                alert("系统异常");
            }
        })
    }
    //修改任务清单
    function edit_qingdan(id, state, task) {
        $.ajax({
            url: "/task/class_edit",
            async: false,
            type: "post",
            data: $('#kanban_edit_class').serialize(),
            success: function (result, testStatus, data) {
                if (result.state == 0) {
                    layer.msg(result.msg)
                } else if (result.state == 1) {
                    let thenews = $('#wd_kanban_dantask' + id + ' .wd_knaban_task');
                    let name = $('#wd_kanban_qing_name' + id).val();
                    edit_quxiao(id, state, name, thenews)
                    layer.msg(result.msg)
                }
            },
            error: function (xhr, errorMessage, e) {
                alert("系统异常");
            }
        })
    }
    // 删除任务清单
    function kanban_qingdan_delete(id) {
        layer.confirm('您真的确定要删除吗？\n\n请确认！', {
            btn: ['是的', '放弃'] //按钮
        }, function () {
            $.ajax({
                url: "/task/class_delete/" + id,
                async: false,
                type: "GET",
                success: function (data, result, msg, testStatus, state) {
                    if (data.state == 0) {
                        layer.msg(data.msg)
                    } else if (data.state == 1) {
                        $('#wd_kanban_taskqingdan' + id).fadeOut();
                        layer.msg(data.msg)
                        setTimeout(function () {
                            $('#wd_kanban_taskqingdan' + id).remove();
                        }, 700)
                    }
                },
                error: function (xhr, errorMessage, e) {
                    alert("系统异常");
                }
            })
        }, function () {
        });
    }
    //归档任务清单
    function kanban_qingdan_guidang(id) {
        layer.confirm('您真的确定要删除吗？\n\n请确认！', {
            btn: ['是的', '放弃'] //按钮
        }, function () {
            $.ajax({
                url: "/task/class_archive/" + id,
                async: false,
                type: "GET",
                success: function (data, result, msg, testStatus, state) {
                    if (data.state == 0) {
                        layer.msg(data.msg)
                    } else if (data.state == 1) {
                        $('#wd_kanban_taskqingdan' + id).fadeOut();
                        layer.msg(data.msg)
                        setTimeout(function () {
                            $('#wd_kanban_taskqingdan' + id).remove();
                        }, 700)
                    }
                },
                error: function (xhr, errorMessage, e) {
                    alert("系统异常");
                }
            })
        }, function () {
        });
    }
    //添加清单下任务
    function wd_kanban_add(id) {
        let dataa = [];
        let auser = [];
        let str = $('#wd_addkanban' + id).serialize();
        let arr = str.split('&');
        for (i = 0; i < arr.length; i++) {
            let tmp = arr[i].split('=');
            if (tmp[0] == 'tag') {
                auser.push(tmp[1]);
            } else {
                dataa.push(arr[i])
            }
        }
        dataa.push("tag=" + auser);
        dataa = dataa.join('&');

        let inppt = $('#wd_kanban_addtask_name' + id).val();
        if ($.trim(inppt) == "") {
            layer.msg('输入名称不能为空')
            return false;
        }
        $.ajax({
            url: "/task/add",
            async: false,
            type: "post",
            data: dataa,
            success: function (result, testStatus, data) {
                if (result.state == 0) {
                    layer.msg(result.msg)
                } else if (result.state == 1) {
                    let task_id = data.responseJSON.data.tgid;
                    kanban_add_task(id, dataa, task_id, kanadduser, kanallper, kanalltag)
                    $('#wd_addkanban' + id).hide();
                    layer.msg(result.msg)
                }
            },
            error: function (xhr, errorMessage, e) {
                alert("系统异常");
            }
        })
    }
    function kanban_add_task(id, dataa, task_id, kanadduser, kanallper, kanalltag) {
        let dataarr = dataa.split('&');
        // console.log(arr)
        for (t = 0; t < dataarr.length; t++) {
            let obj = dataarr[t].split('=')
            if (obj[0] == 'tag') {
                let tag = obj[1];
                kanban_add_task_data(id, tag, task_id, kanadduser, kanallper, kanalltag)
                return false;
            }
        }
    }
    function kanban_add_task_data(id, tag, task_id, kanadduser, kanallper, kanalltag) {
        let task_name = $('#wd_kanban_addtask_name' + id).val();
        let task_time = $('#wd_kanban_addtime' + id).val();
        let task_Head_user_id = $('#wd_knaban_addtask_user' + id).val();
        let Note = $('#wd_kanban_addtask_note' + id).val();
        let Sub = '';
        let State = '1';
        let page = 0

        task_show(id, task_time, task_Head_user_id, task_id, task_name, Note, State, Sub, tag)
        headuserid(task_id, kanadduser, kanallper, task_Head_user_id)

        motasknow(id, task_id, kanadduser, kanallper, task_Head_user_id, task_name, Note, tag, kanalltag, task_time, State)

        kan_loadmaore(task_id, page)
        $('#wd-kanban-alltask' + task_id).css({
            'animation': 'fade 600ms infinite'
        })
        setTimeout(function () {
            $('#wd-kanban-alltask' + task_id).css({
                'animation': ''
            })
        }, 1000)
    }

    //添加任务请求评论接口数据
    function kan_loadmaore(task_id, page) {
        $.ajax({
            url: "/task/log_comment/" + task_id + "/" + page + "/" + 50,
            async: false,
            type: "GET",
            success: function (data) {
                let ping_tmp = data.data;
                let ping_str = JSON.parse(decodeURIComponent(ping_tmp))
                let the_log = ping_str.LogComment
                task_Log_comment(task_id, the_log)
            },
            error: function (xhr, errorMessage, e) {
                // alert("系统异常");
            }
        })
    }
    // 修改任务
    function wd_knaban_motask(task_id,id) {
        let dataa = [];
        let auser = [];
        let str = $('#wd_task_mo' + task_id).serialize();
        let arr = str.split('&');
        for (i = 0; i < arr.length; i++) {
            let tmp = arr[i].split('=');
            if (tmp[0] == 'tag') {
                auser.push(tmp[1]);
            } else {
                dataa.push(arr[i])
            }
        }
        dataa.push("tag=" + auser);
        dataa = dataa.join('&');


        let inppt = $('#wd_kanban_addtask_name' + id).val();
        if ($.trim(inppt) == "") {
            layer.msg('输入名称不能为空')
            return false;
        }
        $.ajax({
            url: "/task/edit",
            async: false,
            type: "post",
            data: dataa,
            success: function (result, testStatus, data) {
                if (result.state == 0) {
                    layer.msg(result.msg)
                } else if (result.state == 1) {
                    wd_kanban_mo(dataa, task_id, kanallper, kanadduser, kanalltag)
                    layer.msg(result.msg)
                }
            },
            error: function (xhr, errorMessage, e) {
                alert("系统异常");
            }
        })
    }
    function wd_kanban_mo(dataa, task_id, kanallper, kanadduser, kanalltag) {
        let moarr = dataa.split('&');
        // console.log(arr)
        for (t = 0; t < moarr.length; t++) {
            let obj = moarr[t].split('=')
            if (obj[0] == 'tag') {
                let tag = obj[1];
                thekanban_mo_task(task_id, tag, kanallper, kanadduser, kanalltag)
                $('#wd_task_mo' + task_id).slideUp()

                return false;
            }
        }
    }
    function thekanban_mo_task(task_id, tag, kanallper, kanadduser, kanalltag) {
        let task_name = $('#thekanban_moname' + task_id).val()
        let task_time = $('#wd_kanban_motime' + task_id).val()
        let task_Head_user_id = $('#wd_knaban_mo_user' + task_id).val()
        let Note = $('#thekanban_monote' + task_id).val()



        $('#wd_knaban_tasknow_name' + task_id).html(parsing(task_name))
        $('#wd_knaban_userdate' + task_id).html(dateyear(decodeURIComponent(task_time)))
        $('#wd_kanban_note' + task_id).html(Note)

        //值赋给详情页面
        $('#the_details_taskname' + task_id).val(task_name)
        $('#the_details_taskdate' + task_id).val(task_time)
        $('#the_details_tasknote' + task_id).val(Note)

        kanban_task_note(Note, task_id)
        headuserid(task_id, kanadduser, kanallper, task_Head_user_id)
        kanban_show_tag(tag, task_id)
        // 指派人赋值
        $('#wd_knaban_mo_user' + task_id).html('')
        $('#the_details_taskuser' + task_id).html('')
        motask_user(task_id, kanadduser, kanallper, task_Head_user_id)
        //标签赋值
        $('#wd_knaban_mo_tag' + task_id).html('')
        $('#the_details_tasktag' + task_id).html('')
        taskmo_tag(task_id, kanallper, tag, kanalltag)

        $('#wd-kanban-alltask' + task_id).css({
            'animation': 'fade 600ms infinite'
        })
        setTimeout(function () {
            $('#wd-kanban-alltask' + task_id).css({
                'animation': ''
            })
        }, 1000)
    }
    function wd_kanban_d_motask(task_id) {
        let dataa = [];
        let auser = [];
        let str = $('#d_tasksub_mo' + task_id).serialize();
        let arr = str.split('&');
        for (i = 0; i < arr.length; i++) {
            let tmp = arr[i].split('=');
            if (tmp[0] == 'tag') {
                auser.push(tmp[1]);
            } else {
                dataa.push(arr[i])
            }
        }
        dataa.push("tag=" + auser);
        dataa = dataa.join('&');
        $.ajax({
            url: "/task/edit",
            async: false,
            type: "post",
            data: dataa,
            success: function (result, testStatus, data) {
                if (result.state == 0) {
                    layer.msg(result.msg)
                } else if (result.state == 1) {
                    d_wd_kanban_mo(dataa, task_id, kanallper, kanadduser, kanalltag) //详情页面任务修改
                    layer.msg(result.msg)
                }
            },
            error: function (xhr, errorMessage, e) {
                alert("系统异常");
            }
        })
    }
    function d_wd_kanban_mo(dataa, task_id, kanallper, kanadduser, kanalltag) {
        let moarr = dataa.split('&');
        // console.log(arr)
        for (t = 0; t < moarr.length; t++) {
            let obj = moarr[t].split('=')
            if (obj[0] == 'tag') {
                let tag = obj[1];
                d_thekanban_mo_task(task_id, tag, kanallper, kanadduser, kanalltag)
                $('#wd_task_mo' + task_id).slideUp()

                return false;
            }
        }
    }
    function d_thekanban_mo_task(task_id, tag, kanallper, kanadduser, kanalltag) {
        let details_taskname = $('#the_details_taskname' + task_id).val()
        let details_task_time = $('#the_details_taskdate' + task_id).val()
        let details_task_headuser = $('#the_details_taskuser' + task_id).val()
        let details_task_note = $('#the_details_tasknote' + task_id).val()

        $('#wd_knaban_tasknow_name' + task_id).html(parsing(details_taskname))
        $('#wd_knaban_userdate' + task_id).html(dateyear(decodeURIComponent(details_task_time)))
        $('#wd_kanban_note' + task_id).html(details_task_note)
        kanban_show_tag(tag, task_id)
        // 指派人赋值
        $('#wd_knaban_mo_user' + task_id).html('')
        $('#the_details_taskuser' + task_id).html('')
        motask_user(task_id, kanadduser, kanallper, details_task_headuser)
        //标签赋值
        $('#wd_knaban_mo_tag' + task_id).html('')
        $('#the_details_tasktag' + task_id).html('')
        // 值赋给修改
        $('#thekanban_moname' + task_id).val(details_taskname)
        $('#wd_kanban_motime' + task_id).val(details_task_time)
        $('#thekanban_monote' + task_id).val(details_task_note)
        kanban_task_note(details_task_note, task_id)
        headuserid(task_id, kanadduser, kanallper, details_task_headuser)
        taskmo_tag(task_id, kanallper, tag, kanalltag)

    }

    function taskdelect(id, task_id) {
        layer.confirm('您真的确定要删除吗？\n\n请确认！', {
            btn: ['是的', '放弃'] //按钮
        }, function () {
            $.ajax({
                url: "/task/delete/" + task_id,
                async: false,
                type: "GET",
                success: function (data, result, msg, testStatus, state) {
                    if (data.state == 0) {
                        layer.msg(data.msg)
                    } else if (data.state == 1) {
                        homeview(task_id)
                        $('#wd_kanban_taskandmo' + task_id).attr('class', '-1')
                        kan_t_num(id)
                        $('#wd_kanban_tasknum' + task_id).css('text-decoration', 'line-through red')
                        $('#pause' + task_id + ' img').css('-webkit-filter', 'grayscale(100%)')
                        $('#wd-kanban-alltask' + task_id).css('animation', 'fade 600ms infinite')
                        $('#wd_task_mo' + task_id).hide();
                        setTimeout(function () {
                            $('#wd-kanban-alltask' + task_id).css({
                                'animation': '',
                                'background-color': '#e3e3e3',
                                'pointer-events': 'none'
                            })
                        }, 1000)
                        layer.msg(data.msg)
                    }
                },
                error: function (xhr, errorMessage, e) {
                    alert("系统异常");
                }
            })
        }, function () {
        });
    }

    // 添加子任务
    function k_subadd(id, task_id) {
        //添加子任务下文本框不能为空格
        let inppt = $('#wd_kanban_subtask_content' + task_id).val();
        if ($.trim(inppt) == "") {
            layer.msg('输入名称不能为空')
            return false;
        }
        $.ajax({
            url: "/task/sub_add",
            async: false,
            type: "post",
            data: $('#k_sub_add_form' + task_id).serialize(),
            success: function (data, result, state) {
                if (data.state == 0) {
                    layer.msg(data.msg)
                }
                else if (data.state == 1) {
                    // $('.wd-stand-task').html('')
                    // task_beacon()
                    let dataid = data.data.tsgid;
                    k_subaddnew(dataid, task_id)
                }
            },
            error: function (xhr, errorMessage, e) {
                alert("系统异常");
            }
        })
    }
    function d_k_subadd(id, task_id) {
        //添加子任务下文本框不能为空格
        let inppt = $('#d_wd_kanban_subtask_content' + task_id).val();
        if ($.trim(inppt) == "") {
            layer.msg('输入名称不能为空')
            return false;
        }
        $.ajax({
            url: "/task/sub_add",
            async: false,
            type: "post",
            data: $('#d_k_sub_add_form' + task_id).serialize(),
            success: function (data, result, state) {
                if (data.state == 0) {
                    layer.msg(data.msg)
                }
                else if (data.state == 1) {
                    // $('.wd-stand-task').html('')
                    // task_beacon()
                    let dataid = data.data.tsgid;
                    d_k_subaddnew(dataid, task_id)

                }
            },
            error: function (xhr, errorMessage, e) {
                alert("系统异常");
            }
        })
    }
    // 添加子任务函数
    function k_subaddnew(dataid, task_id) {
        let sub_content = $('#wd_kanban_subtask_content' + task_id).val()
        let sub_Expect_end_time = $('#wd_kanban_subtask_date' + task_id).val()
        let sub_State = '1'
        addsub_open_pubilc(dataid, sub_content, sub_Expect_end_time, sub_State, task_id)  //公共子任务的添加

        var pau = '<img src="/img/blue_begin.png" title ="暂停中" value="1">'

        var subbox = '<img style="width: 17px;"  src="/img/uncheck.png" title="未完成" value="0">'
        $('#zipause' + dataid).html(pau)
        $('#d_zipause' + dataid).html(pau)

        $('#cboxid' + dataid).html(subbox)
        $('#d_cboxid' + dataid).html(subbox)

        $('#wd_kanban_subtask_content' + task_id).val('')
        $('#wd_kanban_subtask_date' + task_id).val('')
        d_sub_number(task_id)
    }
    // 添加子任务函数
    function d_k_subaddnew(dataid, task_id) {
        let sub_content = $('#d_wd_kanban_subtask_content' + task_id).val()
        let sub_Expect_end_time = $('#d_wd_kanban_subtask_date' + task_id).val()
        let sub_State = '1'
        addsub_open_pubilc(dataid, sub_content, sub_Expect_end_time, sub_State, task_id)  //公共子任务的添加
        var pau = '<img src="/img/blue_begin.png" title ="暂停中" value="1">'
        var subbox = '<img style="width: 17px;"  src="/img/uncheck.png" title="未完成" value="0">'
        $('#zipause' + dataid).html(pau)
        $('#d_zipause' + dataid).html(pau)

        $('#cboxid' + dataid).html(subbox)
        $('#d_cboxid' + dataid).html(subbox)

        $('#d_wd_kanban_subtask_content' + task_id).val('')
        $('#d_wd_kanban_subtask_date' + task_id).val('')
        d_sub_number(task_id)
    }
    //修改子任务
    function subtask_save(sub_id) {
        $.ajax({
            url: "/task/sub_edit",
            async: false,
            type: "post",
            data: $('#addsub_task_form' + sub_id).serialize(),
            success: function (data, result, state) {
                if (data.state == 0) {
                    layer.msg(data.msg)
                }
                else if (data.state == 1) {
                    // layer.msg(data.msg)
                    s_submonew(sub_id)
                }
            },
            error: function (xhr, errorMessage, e) {
                alert("系统异常");
            }
        })
    }
    function d_subtask_save(sub_id) {
        $.ajax({
            url: "/task/sub_edit",
            async: false,
            type: "post",
            data: $('#d_addsub_task_form' + sub_id).serialize(),
            success: function (data, result, state) {
                if (data.state == 0) {
                    layer.msg(data.msg)
                }
                else if (data.state == 1) {
                    // layer.msg(data.msg)
                    d_s_submonew(sub_id)
                }
            },
            error: function (xhr, errorMessage, e) {
                alert("系统异常");
            }
        })
    }
    // 修改子任务函数
    function s_submonew(sub_id) {
        let content = $('#s_kanban_content' + sub_id).val();
        let time = $('#s_ecpect_time' + sub_id).val();
        z_kanban_return_mo(sub_id, content, time)
    }
    // 修改子任务函数
    function d_s_submonew(sub_id) {
        let content = $('#d_s_kanban_content' + sub_id).val();
        let time = $('#d_s_ecpect_time' + sub_id).val();
        z_kanban_return_mo(sub_id, content, time)
    }
    // 删除子任务
    function z_kanban_delect_img(sub_id, task_id) {
        layer.confirm('您真的确定要删除吗？\n\n请确认！', {
            btn: ['是的', '放弃'] //按钮
        }, function (ind) {
            $.ajax({
                url: "/task/sub_delete/" + sub_id,
                async: false,
                type: "GET",
                success: function (data, msg, state) {
                    if (data.state == 0) {
                        layer.msg(data.msg)
                    } else if (data.state == 1) {
                        let content = $('#wd_kanban_sub_name' + sub_id).text();
                        let time = $('#wd_kanban_sub_time' + sub_id).text();
                        z_kanban_return_mo(sub_id, content, time)

                        $('#wd_kanban_sub_name' + sub_id).css('text-decoration', 'line-through red')
                        $('#zipause' + sub_id + ' img').removeAttr('value').css('-webkit-filter', 'grayscale(100%)')
                        $('#cboxid' + sub_id + ' img').removeAttr('value')
                        $('#addsub_task_form' + sub_id).css('animation', 'fade 600ms infinite')
                        setTimeout(function () {
                            $('#addsub_task_form' + sub_id).css({
                                'animation': '',
                                // 'background-color': '#e3e3e3',
                                'pointer-events': 'none'
                            })
                        }, 1000)
                        $('#d_wd_kanban_sub_name' + sub_id).css('text-decoration', 'line-through red')
                        $('#d_zipause' + sub_id + ' img').removeAttr('value').css('-webkit-filter', 'grayscale(100%)')
                        $('#d_cboxid' + sub_id + ' img').removeAttr('value')
                        // $('#d_addsub_task_form' + sub_id).css('animation', 'fade 600ms infinite')
                        setTimeout(function () {
                            $('#d_addsub_task_form' + sub_id).css({
                                'animation': '',
                                // 'background-color': '#e3e3e3',
                                'pointer-events': 'none'
                            })
                        }, 1000)

                        d_sub_number(task_id)
                        complete_task_fin(task_id)
                    }
                    layer.close(ind);
                },
                error: function (xhr, errorMessage, e) {
                    alert("系统异常");
                }
            })
        }, function (ind) {
            layer.close(ind);
        });
    }
    function task_beacon() {
        $.ajax({
            url: "/project/task/{{.project_gid}}",
            type: 'GET',
            beforeSend: function () {
                var index = layer.load(1); //换了种风格
            },
            success: function (data,msg) {
                if (data.state == 0){
                    $('#task_form_qingdan').html('<div class="kanbna_root">'+data.msg+'</div>')
                }else{
                    let task = decodeURIComponent(data.data)
                    let wd_task = JSON.parse(task);
                    if (wd_task != null) {
                        let e_ggid = '{{.project_gid}}'
                        taskqingdan(wd_task, kanadduser, kanallper, kanalltag,e_ggid)
                    } else {
                        alert('出现错误')
                    }
                }
               
            },
            complete: function () {
                var index = layer.load(1); //换了种风格

                layer.close(index);
            },
            error: function (xhr, errorMessage, e) {
                alert(e);
            }

        });
    }

    // 任务的开始等
    // 发送评论
    function p_d_sendtalk(task_id) {
        let input = $('#p_d_textare' + task_id).val();
        if ($.trim(input) == "") {
            layer.msg('任务评论内容不能为空。')
            return false;
        }
        let talkdata = [];
        let content = [];
        let str = $('#p_d_form' + task_id).serialize()
        let arr = str.split('&');

        for (d = 0; d < arr.length; d++) {
            let tmp = arr[d].split('=');
            if (tmp[0] == 'content') {
                content.push(tmp[1])
            } else {
                talkdata.push(arr[d])
            }
        }

        talkdata.push("content=" + content)
        talkdata = talkdata.join('&')
        let cont = talkdata.replace(/,/g, "=$>")
        // let cont=  talkdata.replace(',','=$>')
        $.ajax({
            url: "/task/comment_add",
            async: false,
            type: "post",
            data: cont,
            success: function (result, testStatus, data) {
                if (result.state == 0) {
                    layer.msg(result.msg)
                } else if (result.state == 1) {
                    let arrping = [];
                    let tmp = cont.split('&');
                    for (d = 0; d < tmp.length; d++) {
                        let objping = tmp[d].split('=');

                        if (objping[0] == 'content') {
                            for (h = 0; h < objping.length; h++) {
                                if (objping[h] != 'content') {
                                    let objnew = objping[h].replace('$>', '=$>').replace(/\+/g, '%20')
                                    arrping.push(objnew)

                                }
                            }
                        }
                    }
                    let Id = data.responseJSON.data.cmtid;
                    let myDate = new Date();
                    let myyear = myDate.getFullYear(); //获取完整的年份(4位,1970-???)
                    let myMonth = myDate.getMonth() + 1; // 获取当前月份
                    let myDay = myDate.getDate() // 获取当前日（1- 31）
                    let myHours = myDate.getHours() // 获取当前小时(0-23)
                    let myMinu = myDate.getMinutes() // 获取当前分钟(0-59)
                    // let times = myyear + '-' + myMonth + '-' + myDay + '+' + myHours + ':' + myMinu;
                    let times = '刚刚';
                    // let Content = $('#p_d_textare' + task_id).val();

                    let aee = JSON.parse(localStorage.getItem('userLogin'));
                    let ugid = aee.ugid;
                    let na = decodeURIComponent(aee.name);
                    let nname = na.replace(/\+/g, '')
                    let resultname = nname.replace(/(^\s+)|(\s+$)/g, "");//去掉前后空格
                    // console.log(arrping)
                    d_new_comment(task_id, times, arrping, Id, resultname, ugid)
                    $('#p_d_textare' + task_id).val('');
                    $('#d_wd_ping_aite' + task_id).html('')
                    $('#ping_aite_remove' + task_id).hide()

                    $('#p_d_mo_form' + Id).prependTo($('#p_d_logandcomment' + task_id))
                }
            },
            error: function (xhr, errorMessage, e) {
                alert("系统异常");
            }
        })
    }
    // 删除评论
    function p_d_delect(Id) {
        layer.confirm('您真的确定要删除吗？\n\n请确认！', {
            btn: ['是的', '放弃'] //按钮
        }, function (ind) {
            $.ajax({
                url: "/task/comment_delete/" + Id,
                async: false,
                type: "GET",
                success: function (data, result, msg, testStatus, state) {
                    if (data.state == 0) {
                        layer.msg(data.msg)
                    } else if (data.state == 1) {
                        $('#d_tl_log' + Id).fadeOut();
                        setTimeout(function () {
                            $('#d_tl_log' + Id).remove();
                        }, 500)
                    }
                    layer.close(ind);
                },
                error: function (xhr, errorMessage, e) {
                    alert("系统异常");
                }
            })
        }, function (ind) {
            layer.close(ind);
        });
    }
    // 修改评论
    function p_d_save(id, task_id) {
        let input = $('#p_d_mo_content' + id).val();

        if ($.trim(input) == "") {
            layer.msg('任务评论内容不能为空。')
            return false;
        }
        let talkdata = [];
        let content = [];
        let str = $('#p_d_mo_form' + id).serialize()
        let arr = str.split('&');

        for (d = 0; d < arr.length; d++) {
            let tmp = arr[d].split('=');
            if (tmp[0] == 'content') {
                content.push(tmp[1])
            } else {
                talkdata.push(arr[d])
            }
        }

        talkdata.push("content=" + content)
        talkdata = talkdata.join('&')
        let cont = talkdata.replace(/,/g, "=$>")
        $.ajax({
            url: "/task/comment_edit",
            async: false,
            type: "post",
            data: cont,
            success: function (result, testStatus, data, msg) {
                if (result.state == 0) {
                    layer.msg(result.msg)
                }
                else if (result.state == 1) {
                    p_d_pen_return(id, task_id)
                }
            },
            error: function (xhr, errorMessage, e) {
                alert("系统异常");
            }
        })
    }

    // 任务详情页面下保存和删除的隐藏显示
    function d_mo_btn_show(task_id) {
        $('#k_d_mo' + task_id).fadeIn(); //修改显示
        $('#k_sub_add_form'+task_id).fadeIn();
        $('#d_k_sub_add_form'+task_id).fadeIn();
    }
    function d_mo_btn_hide(task_id) {
        $('#k_d_mo' + task_id).fadeOut();//修改隐藏
        $('#k_sub_add_form'+task_id).fadeOut();
        $('#d_k_sub_add_form'+task_id).fadeOut();
    }
    // 任务修改按钮的隐藏显示
    function k_mo_btn_show(task_id) {
        $('#wd_kanban_modity' + task_id).show()
    }
    function k_mo_btn_hide(task_id) {
        $('#wd_kanban_modity' + task_id).hide()
    }

    // 重新打开任务时关闭解锁
    function allppox(task_id) {
        $('#pause' + task_id).css('pointer-events', 'none');
        $('#d_pause' + task_id).css('pointer-events', 'none');
    }
    function allppox_xing(task_id) {
        $('#pause' + task_id).css('pointer-events', '');
        $('#d_pause' + task_id).css('pointer-events', '');
    }
    // 完成任务时不可点击
    function allsubppox(task_id, sub_id) {
        $('#zipause' + sub_id).css('pointer-events', 'none');
        $('#d_zipause' + sub_id).css('pointer-events', 'none');
    }
    function allsubppox_xing(task_id, sub_id) {
        $('#zipause' + sub_id).css('pointer-events', '');
        $('#d_zipause' + sub_id).css('pointer-events', '');
    }
    function allbbox(task_id) {
        $('#zrw' + task_id).css('pointer-events', 'none');
        $('#d_zrw' + task_id).css('pointer-events', 'none');
    }
    function allbbox_xing(task_id) {
        $('#zrw' + task_id).css('pointer-events', '');
        $('#d_zrw' + task_id).css('pointer-events', '');
    }

    // 状态不同将添加不同div
    function app_div_kanban(sub_id, task_id) {
        $('#addsub_task_form' + sub_id).appendTo('#wd_kanban_subperformance' + task_id).css({
            'margin-left': '5px'
        })
        $('#d_addsub_task_form' + sub_id).appendTo('#d_wd_kanban_subperformance' + task_id)

        app_kanban_password(sub_id, task_id)
    }
    // 存在考核，则不可以修改
    function app_kanban_password(sub_id, task_id) {
        $('#wd_kanban_mo_style_mo' + task_id).html('<div class="wd-stand-task-suo' + task_id + '" style="margin-left: 10px;"><img style="width: 15px;" src="/img/Task/suo.png"title="任务中有已保存的审核表，禁止修改"></div>')
        $('#k_d_mo' + task_id).html('<img class="wd-stand-task-suo' + task_id + '"  style="width: 15px;" src="/img/Task/suo.png"title="任务中有已保存的审核表，禁止修改"><hr>')

        $('.wd-stand-task-suo' + task_id).click(function () {
            layer.msg('任务下的子任务正在审核，禁止修改')
        })
    }
    function nopoint_a_shan(sub_id) {
        $('#addsub_task_form' + sub_id).css('animation', 'fade 600ms infinite')
        setTimeout(function () {
            $('#addsub_task_form' + sub_id).css('animation', '')
        }, 1000)

        $('#d_addsub_task_form' + sub_id).css('animation', 'fade 600ms infinite')
        setTimeout(function () {
            $('#d_addsub_task_form' + sub_id).css('animation', '')
        }, 1000)
    }
    // 子任务完成或未完成
    function allsubbbox(sub_id) {
        $('#cboxid' + sub_id).css('pointer-events', 'none');
        $('#d_cboxid' + sub_id).css('pointer-events', 'none');
    }
    function allsubbbox_xing(sub_id) {
        $('#cboxid' + sub_id).css('pointer-events', '');
        $('#d_cboxid' + sub_id).css('pointer-events', '');
    }
    // 子任务的修改删除标识的隐藏显示
    function sub_btn_show(sub_id) {
        $('#wd_knaban_sub_usetwo' + sub_id).show();
        $('#wd_kanban_d_sub_use' + sub_id).show()
    }
    function sub_btn_hide(sub_id) {
        $('#wd_knaban_sub_usetwo' + sub_id).hide();
        $('#wd_kanban_d_sub_use' + sub_id).hide()
    }
    function pause_task(task_id, task_id) {
        let pauses = $('#pause' + task_id + ' img').attr("value");
        if (pauses == 0) {
            setTimeout(function () {
                $('#pause' + task_id).html('<img class="kanban_loading_style" src="/img/loadinga.gif" title ="等待中">');
                $('#d_pause' + task_id).html('<img class="kanban_loading_style" src="/img/loadinga.gif" title ="等待中">');
                allppox(task_id)
            });
            setTimeout(function () {
                Task_Pause(task_id, function (err, data) {
                    if (err) {
                        layer.msg(err)
                        return
                    }
                    allppox_xing(task_id)
                    if (data.state == 1) {
                        layer.msg(data.msg)
                        $('#pause' + task_id).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">');
                        $('#d_pause' + task_id).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">');
                        // let arr = $('#todolist'+k+' .zirenwu img');
                        let arr = $('#wd_kanban_suball' + task_id + ' .zirenwu');
                        for (let j = 0; j < arr.length; j++) {
                            let fff = arr[j].getAttribute('id');
                            // 获取子任务开始暂停图标的vaue值用以判断是开始还是暂停
                            let yy = $('#' + fff + ' img').attr('value');

                            if (yy == 0) {
                                $('#' + fff).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">');
                            }
                        }
                        let d_arr = $('#the_details_sub' + task_id + ' .zirenwu');
                        for (let j = 0; j < d_arr.length; j++) {
                            let fff = d_arr[j].getAttribute('id');

                            // 获取子任务开始暂停图标的vaue值用以判断是开始还是暂停
                            let yy = $('#' + fff + ' img').attr('value');
                            if (yy == 0) {
                                $('#' + fff).html('<img style="width:12px;" src="/img/blue_begin.png" title ="暂停中" value="1">');
                            }
                        }
                    }
                    if (data.state == 0) {
                        layer.msg(data.msg)
                        $('#pause' + task_id).html('<img src="/img/red_end.png" title ="开始中" value="0">');
                        $('#d_pause' + task_id).html('<img src="/img/red_end.png" title ="开始中" value="0">');
                        // $('#d_pause' + i).html('<img style="width:15px;" src="/img/red_end.png" title ="开始中" value="0">');
                    }
                })
            }, 700);
        }

        else {
            setTimeout(function () {
                $('#pause' + task_id).html('<img class="kanban_loading_style" src="/img/loadinga.gif" title ="等待中">');
                $('#d_pause' + task_id).html('<img class="kanban_loading_style" src="/img/loadinga.gif" title ="等待中">');
                allppox(task_id)
            });
            setTimeout(function () {
                Task_Start(task_id, function (err, data) {
                    if (err) {
                        layer.msg(err)
                        return
                    }
                    allppox_xing(task_id)
                    if (data.state == 1) {
                        layer.msg(data.msg)
                        $('#pause' + task_id).html('<img src="/img/red_end.png" title ="开始中" value="0">');
                        $('#d_pause' + task_id).html('<img src="/img/red_end.png" title ="开始中" value="0">');
                    }
                    if (data.state == 0) {
                        layer.msg(data.msg)
                        $('#pause' + task_id).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">');
                        $('#d_pause' + task_id).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">');
                    }
                })
            }, 700);
            // task_start(Task_id)
            // $('#pause'+k).html('<img src="/img/red_end.png" title ="开始中" value="0">');
        }
    }

    // 触发子任务开始暂停函数
    function zipause(sub_id, task_id) {

        // 检查项状态，定义“-1”为不可用，“0”为冻结状态，“1”为正常(未开始或暂停)，“2”为开始状态，“3”为已完成，默认为”1“。
        // alert(Sub_id);
        let pauses = $('#zipause' + sub_id + ' img').attr("value");
        if (pauses == 0) {
            setTimeout(function () {
                $('#zipause' + sub_id).html('<img class="kanban_loading_style" src="/img/loadinga.gif" title ="等待中">');
                allsubppox(task_id, sub_id)
            });
            setTimeout(function () {
                sub_Pause(sub_id, function (err, data) {
                    if (err) {
                        layer.msg(err)
                        return
                    }
                    allsubppox_xing(task_id, sub_id)
                    // $('#zipause'+k+i).html('<img src="/img/loadinga.gif" title ="等待中">');
                    if (data.state == 1) {
                        layer.msg(data.msg)
                        $('#zipause' + sub_id).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">');
                        $('#d_zipause' + sub_id).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">');
                        // 如果返回值为-1，说明所有子任务都暂停了，父任务也暂停
                        if (zhuzi(task_id) == '-1') {
                            $('#pause' + task_id).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">');
                            // 详细
                            $('#d_pause' + task_id).html('<img style="width:15px;" src="/img/blue_begin.png" title ="暂停中" value="1">');
                        }
                        if (data.state == 0) {
                            layer.msg(data.msg)
                            $('#zipause' + sub_id).html('<img src="/img/red_end.png" title ="开始中" value="0">');
                            $('#d_zipause' + sub_id).html('<img src="/img/red_end.png" title ="开始中" value="0">');
                        }
                    }
                })
            }, 700);
            // 如果等于0说明任务处于开始状态，一下操作是要将它暂停

        } else {
            setTimeout(function () {
                $('#zipause' + sub_id).html('<img class="kanban_loading_style" src="/img/loadinga.gif" title ="等待中">');
                allsubppox(task_id, sub_id)
            });
            setTimeout(function () {
                // 说明任务处于暂停状态，将它开始
                sub_Start(sub_id, function (err, data) {
                    if (err) {
                        layer.msg(err)
                        return
                    }
                    allsubppox_xing(task_id, sub_id)
                    if (data.state == 1) {
                        layer.msg(data.msg)
                        $('#zipause' + sub_id).html('<img src="/img/red_end.png" title ="开始中" value="0">');
                        $('#pause' + task_id).html('<img src="/img/red_end.png" title ="开始中" value="0">');

                        $('#d_zipause' + sub_id).html('<img src="/img/red_end.png" title ="开始中" value="0">');
                        $('#d_pause' + task_id).html('<img style="width:15px;" src="/img/red_end.png" title ="开始中" value="0">');
                    }
                    if (data.state == 0) {
                        layer.msg(data.msg)
                        $('#zipause' + sub_id).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">');
                        $('#d_zipause' + isub_id).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">');
                    }
                })
            }, 700);
        }
    }
    // 任务详情页下子任务
    function d_zipause(sub_id, task_id) {

        // 检查项状态，定义“-1”为不可用，“0”为冻结状态，“1”为正常(未开始或暂停)，“2”为开始状态，“3”为已完成，默认为”1“。
        // alert(Sub_id);
        let pauses = $('#d_zipause' + sub_id + ' img').attr("value");
        if (pauses == 0) {
            setTimeout(function () {
                $('#d_zipause' + sub_id).html('<img class="kanban_loading_style" src="/img/loadinga.gif" title ="等待中">');
                allsubppox(task_id, sub_id)
            });
            setTimeout(function () {
                sub_Pause(sub_id, function (err, data) {
                    if (err) {
                        layer.msg(err)
                        return
                    }
                    allsubppox_xing(task_id, sub_id)
                    // $('#zipause'+k+i).html('<img src="/img/loadinga.gif" title ="等待中">');
                    if (data.state == 1) {
                        layer.msg(data.msg)
                        $('#zipause' + sub_id).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">');
                        $('#d_zipause' + sub_id).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">');
                        // 如果返回值为-1，说明所有子任务都暂停了，父任务也暂停
                        if (d_zhuzi(task_id) == '-1') {
                            $('#pause' + task_id).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">');
                            // 详细
                            $('#d_pause' + task_id).html('<img style="width:15px;" src="/img/blue_begin.png" title ="暂停中" value="1">');
                        }
                        if (data.state == 0) {
                            layer.msg(data.msg)
                            $('#zipause' + sub_id).html('<img src="/img/red_end.png" title ="开始中" value="0">');
                            $('#d_zipause' + sub_id).html('<img src="/img/red_end.png" title ="开始中" value="0">');
                        }
                    }
                })
            }, 700);
            // 如果等于0说明任务处于开始状态，一下操作是要将它暂停

        } else {
            setTimeout(function () {
                $('#d_zipause' + sub_id).html('<img class="kanban_loading_style" src="/img/loadinga.gif" title ="等待中">');
                allsubppox(task_id, sub_id)
            });
            setTimeout(function () {
                // 说明任务处于暂停状态，将它开始
                sub_Start(sub_id, function (err, data) {
                    if (err) {
                        layer.msg(err)
                        return
                    }
                    allsubppox_xing(task_id, sub_id)
                    if (data.state == 1) {
                        layer.msg(data.msg)
                        $('#zipause' + sub_id).html('<img src="/img/red_end.png" title ="开始中" value="0">');
                        $('#pause' + task_id).html('<img src="/img/red_end.png" title ="开始中" value="0">');

                        $('#d_zipause' + sub_id).html('<img src="/img/red_end.png" title ="开始中" value="0">');
                        $('#d_pause' + task_id).html('<img style="width:15px;" src="/img/red_end.png" title ="开始中" value="0">');
                    }
                    if (data.state == 0) {
                        layer.msg(data.msg)
                        $('#zipause' + sub_id).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">');
                        $('#d_zipause' + isub_id).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">');
                    }
                })
            }, 700);
        }
    }
    // 任务暂停开始判断


    function boxover(task_id, task_id) {
        let zrw = $('#zrw' + task_id + ' img').attr("value");
        if (zrw == 0) {
            setTimeout(function () {
                $('#zrw' + task_id).html('<img src="/img/loading.gif" title ="等待中">');
                allbbox(task_id)
            });
            setTimeout(function () {
                // 当父任务完成时，子任务要全部完成
                Task_complete(task_id, function (err, data) {
                    if (err) {
                        layer.msg(err)
                        return
                    }
                    allbbox_xing(task_id)
                    if (data.state == 1) {
                        layer.msg(data.msg)
                        $('#zrw' + task_id).html('<img  src="/img/checked.png" title ="已完成" value="1">');
                        $('#pause' + task_id).html('<img src="/img/kb.png" title ="已完成" value="11">');
                        $('#pause' + task_id).css('pointer-events', 'none');

                        $('#d_zrw' + task_id).html('<img  src="/img/checked.png" title ="已完成" value="1">');
                        $('#d_pause' + task_id).html('<img src="/img/kb.png" title ="已完成" value="11">');
                        $('#d_pause' + task_id).css('pointer-events', 'none');
                        // 任务详情页面下修改删除按钮的隐藏
                        d_mo_btn_hide(task_id)
                        // 任务下修改删除标识隐藏
                        k_mo_btn_hide(task_id)

                        // let arr = $('#todolist'+k+' .zirenwu img');
                        let arr = $('#wd-kanban-alltask' + task_id + ' .complete');
                        for (let j = 0; j < arr.length; j++) {
                            // 获取子任务下开始暂停图标的span的id
                            let fff = arr[j].getAttribute('id');
                            // 获取子任务开始暂停图标的vaue值用以判断是开始还是暂停
                            let yy = $('#' + fff + ' img').attr('value');
                            if (yy == 0) {
                                let nff = fff.split('cboxid')
                                $('#' + fff).html('<img style="width: 17px;"  src="/img/checked.png" title="已完成" value="1">');
                                $('#zipause' + nff[1]).html('<img src="/img/kb.png" title ="已完成" value="11">');
                                $('#zipause' + nff[1]).css('pointer-events', 'none');

                                $('#d_zipause' + nff[1]).html('<img src="/img/kb.png" title ="已完成" value="11">');
                                $('#d_zipause' + nff[1]).css('pointer-events', 'none');

                            }
                        }

                        let d_arr = $('#the_details_sub' + task_id + ' .complete');
                        for (let j = 0; j < d_arr.length; j++) {
                            // 获取子任务下开始暂停图标的span的id
                            let fff = d_arr[j].getAttribute('id');
                            // 获取子任务开始暂停图标的vaue值用以判断是开始还是暂停
                            let yy = $('#' + fff + ' img').attr('value');
                            if (yy == 0) {
                                let nff = fff.split('d_cboxid')
                                $('#' + fff).html('<img style="width: 17px;"  src="/img/checked.png" title="已完成" value="1">');
                                $('#zipause' + nff[1]).html('<img src="/img/kb.png" title ="已完成" value="11">');
                                $('#zipause' + nff[1]).css('pointer-events', 'none');

                                $('#d_zipause' + nff[1]).html('<img src="/img/kb.png" title ="已完成" value="11">');
                                $('#d_zipause' + nff[1]).css('pointer-events', 'none');

                            }
                        }

                    }
                    d_sub_complete_num(task_id)
                    if (data.state == 0) {
                        layer.msg(data.msg)
                        $('#zrw' + task_id).html('<img src="/img/uncheck.png" title ="未完成" value="0">');
                        $('#d_zrw' + task_id).html('<img src="/img/uncheck.png" title ="未完成" value="0">');
                    }

                })
            }, 700);
            // Task_complete(Task_id,k)
        } else {
            setTimeout(function () {
                $('#zrw' + task_id).html('<img style="width: 17px;"  src="/img/loading.gif" title ="等待中">');
                allbbox(task_id)
            });
            setTimeout(function () {
                Task_Reopen(task_id, function (err, data) {
                    if (err) {
                        layer.msg(err)
                        return
                    }
                    allbbox_xing(task_id)
                    if (data.state == 1) {
                        layer.msg(data.msg)
                        $('#zrw' + task_id).html('<img src="/img/uncheck.png" title ="未完成" value="0">');
                        $('#pause' + task_id).html('<img src="/img/blue_begin.png" title ="已完成" value="1">');
                        $('#pause' + task_id).css('pointer-events', '');

                        $('#d_zrw' + task_id).html('<img src="/img/uncheck.png" title ="未完成" value="0">');
                        $('#d_pause' + task_id).html('<img src="/img/blue_begin.png" title ="已完成" value="1">');
                        $('#d_pause' + task_id).css('pointer-events', '');

                        // 任务详情页面下修改删除按钮的显示
                        d_mo_btn_show(task_id)
                        // 任务下修改删除标识显示
                        k_mo_btn_show(task_id)
                    }
                    if (data.state == 0) {
                        layer.msg(data.msg)
                        $('#zrw' + task_id).html('<img src="/img/checked.png" title ="已完成" value="1">');
                        $('#d_zrw' + task_id).html('<img src="/img/checked.png" title ="已完成" value="1">');
                    }
                })
            }, 700);
        }
    }

    function d_boxover(task_id, task_id) {
        let zrw = $('#d_zrw' + task_id + ' img').attr("value");
        if (zrw == 0) {
            setTimeout(function () {
                $('#d_zrw' + task_id).html('<img src="/img/loading.gif" title ="等待中">');
                allbbox(task_id)
            });
            setTimeout(function () {
                // 当父任务完成时，子任务要全部完成
                Task_complete(task_id, function (err, data) {
                    if (err) {
                        layer.msg(err)
                        return
                    }
                    allbbox_xing(task_id)
                    if (data.state == 1) {
                        layer.msg(data.msg)
                        $('#zrw' + task_id).html('<img  src="/img/checked.png" title ="已完成" value="1">');
                        $('#pause' + task_id).html('<img src="/img/kb.png" title ="已完成" value="11">');
                        $('#pause' + task_id).css('pointer-events', 'none');

                        $('#d_zrw' + task_id).html('<img  src="/img/checked.png" title ="已完成" value="1">');
                        $('#d_pause' + task_id).html('<img src="/img/kb.png" title ="已完成" value="11">');
                        $('#d_pause' + task_id).css('pointer-events', 'none');
                        // 任务详情页面下修改删除按钮的隐藏
                        d_mo_btn_hide(task_id)
                        // 任务下修改删除标识隐藏
                        k_mo_btn_hide(task_id)

                        // let arr = $('#todolist'+k+' .zirenwu img');
                        let arr = $('#wd-kanban-alltask' + task_id + ' .complete');
                        for (let j = 0; j < arr.length; j++) {
                            // 获取子任务下开始暂停图标的span的id
                            let fff = arr[j].getAttribute('id');
                            // 获取子任务开始暂停图标的vaue值用以判断是开始还是暂停
                            let yy = $('#' + fff + ' img').attr('value');
                            if (yy == 0) {
                                let nff = fff.split('cboxid')
                                $('#' + fff).html('<img style="width: 17px;"  src="/img/checked.png" title="已完成" value="1">');
                                $('#zipause' + nff[1]).html('<img src="/img/kb.png" title ="已完成" value="11">');
                                $('#zipause' + nff[1]).css('pointer-events', 'none');

                                $('#d_zipause' + nff[1]).html('<img src="/img/kb.png" title ="已完成" value="11">');
                                $('#d_zipause' + nff[1]).css('pointer-events', 'none');

                            }
                        }

                        let d_arr = $('#the_details_d_sub' + task_id + ' .complete');
                        for (let j = 0; j < d_arr.length; j++) {
                            // 获取子任务下开始暂停图标的span的id
                            let fff = d_arr[j].getAttribute('id');
                            // 获取子任务开始暂停图标的vaue值用以判断是开始还是暂停
                            let yy = $('#' + fff + ' img').attr('value');
                            if (yy == 0) {
                                let nff = fff.split('d_cboxid')
                                $('#' + fff).html('<img style="width: 17px;"  src="/img/checked.png" title="已完成" value="1">');
                                $('#zipause' + nff[1]).html('<img src="/img/kb.png" title ="已完成" value="11">');
                                $('#zipause' + nff[1]).css('pointer-events', 'none');

                                $('#d_zipause' + nff[1]).html('<img src="/img/kb.png" title ="已完成" value="11">');
                                $('#d_zipause' + nff[1]).css('pointer-events', 'none');
                            }
                        }
                    }
                    d_sub_complete_num(task_id)
                    if (data.state == 0) {
                        layer.msg(data.msg)
                        $('#zrw' + task_id).html('<img src="/img/uncheck.png" title ="未完成" value="0">');
                        $('#d_zrw' + task_id).html('<img src="/img/uncheck.png" title ="未完成" value="0">');
                    }

                })
            }, 700);
            // Task_complete(Task_id,k)
        } else {
            setTimeout(function () {
                $('#d_zrw' + task_id).html('<img src="/img/loading.gif" title ="等待中">');
                allbbox(task_id)
            });
            setTimeout(function () {
                Task_Reopen(task_id, function (err, data) {
                    if (err) {
                        layer.msg(err)
                        return
                    }
                    allbbox_xing(task_id)
                    if (data.state == 1) {
                        layer.msg(data.msg)
                        $('#zrw' + task_id).html('<img src="/img/uncheck.png" title ="未完成" value="0">');
                        $('#pause' + task_id).html('<img src="/img/blue_begin.png" title ="已完成" value="1">');
                        $('#pause' + task_id).css('pointer-events', '');

                        $('#d_zrw' + task_id).html('<img src="/img/uncheck.png" title ="未完成" value="0">');
                        $('#d_pause' + task_id).html('<img src="/img/blue_begin.png" title ="已完成" value="1">');
                        $('#d_pause' + task_id).css('pointer-events', '');

                        // 任务详情页面下修改删除按钮的显示
                        d_mo_btn_show(task_id)
                        // 任务下修改删除标识显示
                        k_mo_btn_show(task_id)
                    }
                    if (data.state == 0) {
                        layer.msg(data.msg)
                        $('#zrw' + task_id).html('<img src="/img/checked.png" title ="已完成" value="1">');
                        $('#d_zrw' + task_id).html('<img src="/img/checked.png" title ="已完成" value="1">');
                    }
                })
            }, 700);
        }
    }

    function zirenwu(task_id, sub_id) {
        let ad = $('#cboxid' + sub_id + ' img').attr("value");
        // let ad = $('#cboxid'+k+i).attr("value");
        if (ad == 0) {
            setTimeout(function () {
                $('#cboxid' + sub_id).html('<img src="/img/loading.gif" title ="等待中">');
                allsubbbox(sub_id)
            });
            setTimeout(function () {
                sub_Complete(sub_id, function (err, data) {
                    if (err) {
                        layer.msg(err)
                        return
                    }
                    allsubbbox_xing(sub_id)
                    if (data.state == 1) {
                        layer.msg(data.msg)
                        $('#cboxid' + sub_id).html('<img  src="/img/checked.png" title ="已完成" value="1">');
                        $('#zipause' + sub_id).html('<img src="/img/kb.png" title ="已完成" value="11">');
                        $('#zipause' + sub_id).css('pointer-events', 'none');

                        $('#d_cboxid' + sub_id).html('<img  src="/img/checked.png" title ="已完成" value="1">');
                        $('#d_zipause' + sub_id).html('<img src="/img/kb.png" title ="已完成" value="11">');
                        $('#d_zipause' + sub_id).css('pointer-events', 'none');
                        nopoint_append(sub_id, task_id) //完成下去
                        sub_btn_hide(sub_id) //子任务的删除标识隐藏


                        // 当一个子任务完成，其他的子任务都是暂停时，父任务也暂停
                        if (zhuzi(task_id) == -1) {
                            $('#pause' + task_id).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">');
                            $('#pause' + task_id).css('pointer-events', '');

                            $('#d_pause' + task_id).html('<img style="width: 15px;" src="/img/blue_begin.png" title ="暂停中" value="1">');
                            $('#d_pause' + task_id).css('pointer-events', '');
                            // 当子任务是最后一个完成的子任务时，父任务自动完成
                            if (zirenwuok(task_id) == '-1') {
                                $('#pause' + task_id).html('<img src="/img/kb.png" title ="空白" value="11">');
                                $('#zrw' + task_id).html('<img  src="/img/checked.png" title ="已完成" value="1">');
                                $('#pause' + task_id).css('pointer-events', 'none');

                                $('#d_pause' + task_id).html('<img src="/img/kb.png" title ="空白" value="11">');
                                $('#d_zrw' + task_id).html('<img style="width: 32px;" src="/img/checked.png" title ="已完成" value="1">');
                                $('#d_pause' + task_id).css('pointer-events', 'none');

                                // 任务详情页面下修改删除按钮的隐藏
                                d_mo_btn_hide(task_id)
                                // 任务下修改删除标识隐藏
                                k_mo_btn_hide(task_id)
                            }
                        }
                        d_sub_complete_num(task_id)
                    }
                    if (data.state == 0) {
                        layer.msg(data.msg)
                        $('#cboxid' + sub_id).html('<img src="/img/uncheck.png" title ="未完成" value="0">');
                        $('#d_cboxid' + sub_id).html('<img src="/img/uncheck.png" title ="未完成" value="0">');
                    }
                })
            }, 700);
        } else {
            setTimeout(function () {
                $('#cboxid' + sub_id).html('<img style="width: 17px;"  src="/img/loading.gif" title ="等待中">');
                allsubbbox(sub_id)
            });
            setTimeout(function () {
                sub_Reopen(sub_id, function (err, data) {
                    if (err) {
                        layer.msg(err)
                        return
                    }
                    allsubbbox_xing(sub_id)
                    if (data.state == 1) {
                        layer.msg(data.msg)
                        // 子任务重新打开时，改为未选中状态的图标
                        $('#cboxid' + sub_id).html('<img  src="/img/uncheck.png" title ="未完成" value="0">');
                        // 子任务重新打开时，显示开始暂停按钮
                        $('#zipause' + sub_id).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">');
                        $('#zipause' + sub_id).css('pointer-events', '');

                        $('#d_cboxid' + sub_id).html('<img  src="/img/uncheck.png" title ="未完成" value="0">');
                        // 子任务重新打开时，显示开始暂停按钮
                        $('#d_zipause' + sub_id).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">');
                        $('#d_zipause' + sub_id).css('pointer-events', '');
                        sub_btn_show(sub_id) //子任务的删除标识显示
                        nopoint_prepend(sub_id, task_id) //完成上去
                        // let numval = $('#wd-stand-sub_stat' + i).text()
                        // let numa = numval.split('/')

                        // 子任务重新打开时，父任务重新打开，并且显示父任务的开始暂停按钮
                        if (zhuzi(task_id) == -1) {
                            $('#zrw' + task_id).html('<img src="/img/uncheck.png" title ="未完成" value="0">');
                            $('#pause' + task_id).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">');
                            $('#pause' + task_id).css('pointer-events', '');

                            $('#d_zrw' + task_id).html('<img src="/img/uncheck.png" title ="未完成" value="0">');
                            $('#d_pause' + task_id).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">');
                            $('#d_pause' + task_id).css('pointer-events', '');

                            // 任务详情页面下修改删除按钮的显示
                            d_mo_btn_show(task_id)
                            // 任务下修改删除标识显示
                            k_mo_btn_show(task_id)
                        }

                        d_sub_complete_num(task_id)
                    }
                    if (data.state == 0) {
                        layer.msg(data.msg)
                        $('#cboxid' + sub_id).html('<img src="/img/checked.png" title ="已完成" value="1">');
                        $('#d_cboxid' + sub_id).html('<img src="/img/checked.png" title ="已完成" value="1">');
                    }
                })
            }, 700);
        }
    }
    function d_zirenwu(task_id, sub_id) {
        let ad = $('#d_cboxid' + sub_id + ' img').attr("value");
        // let ad = $('#cboxid'+k+i).attr("value");
        if (ad == 0) {
            setTimeout(function () {
                $('#d_cboxid' + sub_id).html('<img src="/img/loading.gif" title ="等待中">');
                allsubbbox(sub_id)
            });
            setTimeout(function () {
                sub_Complete(sub_id, function (err, data) {
                    if (err) {
                        layer.msg(err)
                        return
                    }
                    allsubbbox_xing(sub_id)
                    if (data.state == 1) {
                        layer.msg(data.msg)
                        $('#cboxid' + sub_id).html('<img  src="/img/checked.png" title ="已完成" value="1">');
                        $('#zipause' + sub_id).html('<img src="/img/kb.png" title ="已完成" value="11">');
                        $('#zipause' + sub_id).css('pointer-events', 'none');

                        $('#d_cboxid' + sub_id).html('<img  src="/img/checked.png" title ="已完成" value="1">');
                        $('#d_zipause' + sub_id).html('<img src="/img/kb.png" title ="已完成" value="11">');
                        $('#d_zipause' + sub_id).css('pointer-events', 'none');

                        sub_btn_hide(sub_id) //子任务的删除标识隐藏
                        nopoint_append(sub_id, task_id) //完成下去

                        // 当一个子任务完成，其他的子任务都是暂停时，父任务也暂停
                        if (d_zhuzi(task_id) == -1) {
                            $('#pause' + task_id).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">');
                            $('#pause' + task_id).css('pointer-events', '');

                            $('#d_pause' + task_id).html('<img style="width: 15px;" src="/img/blue_begin.png" title ="暂停中" value="1">');
                            $('#d_pause' + task_id).css('pointer-events', '');
                            // 当子任务是最后一个完成的子任务时，父任务自动完成
                            if (zirenwuok(task_id) == '-1') {
                                $('#pause' + task_id).html('<img src="/img/kb.png" title ="空白" value="11">');
                                $('#zrw' + task_id).html('<img  src="/img/checked.png" title ="已完成" value="1">');
                                $('#pause' + task_id).css('pointer-events', 'none');

                                $('#d_pause' + task_id).html('<img src="/img/kb.png" title ="空白" value="11">');
                                $('#d_zrw' + task_id).html('<img style="width: 32px;" src="/img/checked.png" title ="已完成" value="1">');
                                $('#d_pause' + task_id).css('pointer-events', 'none');

                                // 任务详情页面下修改删除按钮的隐藏
                                d_mo_btn_hide(task_id)
                                // 任务下修改删除标识隐藏
                                k_mo_btn_hide(task_id)
                            }
                        }

                        dsub_d_sub_complete_num(task_id)
                    }
                    if (data.state == 0) {
                        layer.msg(data.msg)
                        $('#cboxid' + sub_id).html('<img src="/img/uncheck.png" title ="未完成" value="0">');
                        $('#d_cboxid' + sub_id).html('<img src="/img/uncheck.png" title ="未完成" value="0">');
                    }
                })
            }, 700);
        } else {
            setTimeout(function () {
                $('#d_cboxid' + sub_id).html('<img style="width: 17px;"  src="/img/loading.gif" title ="等待中">');
                allsubbbox(sub_id)
            });
            setTimeout(function () {
                sub_Reopen(sub_id, function (err, data) {
                    if (err) {
                        layer.msg(err)
                        return
                    }
                    allsubbbox_xing(sub_id)
                    if (data.state == 1) {
                        layer.msg(data.msg)
                        // 子任务重新打开时，改为未选中状态的图标
                        $('#cboxid' + sub_id).html('<img  src="/img/uncheck.png" title ="未完成" value="0">');
                        // 子任务重新打开时，显示开始暂停按钮
                        $('#zipause' + sub_id).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">');
                        $('#zipause' + sub_id).css('pointer-events', '');

                        $('#d_cboxid' + sub_id).html('<img  src="/img/uncheck.png" title ="未完成" value="0">');
                        // 子任务重新打开时，显示开始暂停按钮
                        $('#d_zipause' + sub_id).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">');
                        $('#d_zipause' + sub_id).css('pointer-events', '');
                        sub_btn_show(sub_id) //子任务的删除标识显示

                        nopoint_prepend(sub_id, task_id) //完成上去

                        // 子任务重新打开时，父任务重新打开，并且显示父任务的开始暂停按钮
                        if (zhuzi(task_id) == -1) {
                            $('#zrw' + task_id).html('<img src="/img/uncheck.png" title ="未完成" value="0">');
                            $('#pause' + task_id).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">');
                            $('#pause' + task_id).css('pointer-events', '');

                            $('#d_zrw' + task_id).html('<img src="/img/uncheck.png" title ="未完成" value="0">');
                            $('#d_pause' + task_id).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">');
                            $('#d_pause' + task_id).css('pointer-events', '');

                            // 任务详情页面下修改删除按钮的显示
                            d_mo_btn_show(task_id)
                            // 任务下修改删除标识显示
                            k_mo_btn_show(task_id)
                        }
                        dsub_d_sub_complete_num(task_id)
                    }
                    if (data.state == 0) {
                        layer.msg(data.msg)
                        $('#cboxid' + sub_id).html('<img src="/img/checked.png" title ="已完成" value="1">');
                        $('#d_cboxid' + sub_id).html('<img src="/img/checked.png" title ="已完成" value="1">');
                    }
                })
            }, 700);
        }
    }

    function zhuzi(task_id) {
        var rrr = new Array();

        let arr = $('#wd-kanban-alltask' + task_id + ' .zirenwu img');

        for (let j = 0; j < arr.length; j++) {

            rrr.push(arr[j].getAttribute('value'));
        }

        let index = rrr.indexOf('0');
        return index
    }
    function d_zhuzi(task_id) {
        var rrr = new Array();

        let arr = $('#the_details_sub' + task_id + ' .zirenwu img');

        for (let j = 0; j < arr.length; j++) {

            rrr.push(arr[j].getAttribute('value'));
        }

        let index = rrr.indexOf('0');
        return index
    }
    function zirenwuok(task_id) {


        var rrr = new Array();
        // $('#zipause'+k+i).html('<img src="/img/blue_begin.png" value="1">');
        let arr = $('#wd-kanban-alltask' + task_id + ' .complete img');

        for (let j = 0; j < arr.length; j++) {

            rrr.push(arr[j].getAttribute('value'));
        }
        let index = rrr.indexOf('0');
        return index
    }

    function complete_num(task_id) {
        let dearr = $('#wd_kanban_suball' + task_id + ' .complete');
        for (let j = 0; j < dearr.length; j++) {
            // 获取子任务下开始暂停图标的span的id
            let fff = dearr[j].getAttribute('id');
            // 获取子任务开始暂停图标的vaue值用以判断是开始还是暂停
            let yy = $('#' + fff + ' img').attr('value');
            if (yy == 0) {
                let nff = fff.split('cboxid')
                $('#' + fff).html('<img style="width: 17px;"  src="/img/checked.png" title="已完成" value="1">');
                $('#zipause' + nff[1]).html('<img src="/img/kb.png" title ="已完成" value="11">').css('pointer-events', 'none');

                $('#d_zipause' + nff[1]).html('<img src="/img/kb.png" title ="已完成" value="11">').css('pointer-events', 'none');
            }
        }
    }
    function d_complete_num(task_id) {
        let dearr = $('#wd_kanban_suball' + task_id + ' .complete');
        for (let j = 0; j < dearr.length; j++) {
            // 获取子任务下开始暂停图标的span的id
            let fff = dearr[j].getAttribute('id');
            // 获取子任务开始暂停图标的vaue值用以判断是开始还是暂停
            let yy = $('#' + fff + ' img').attr('value');
            if (yy == 0) {
                let nff = fff.split('d_cboxid')
                $('#' + fff).html('<img style="width: 17px;"  src="/img/checked.png" title="已完成" value="1">');
                $('#zipause' + nff[1]).html('<img src="/img/kb.png" title ="已完成" value="11">').css('pointer-events', 'none');

                $('#d_zipause' + nff[1]).html('<img src="/img/kb.png" title ="已完成" value="11">').css('pointer-events', 'none');
            }
        }
    }

    function complete_task_fin(task_id) {
        if (d_zhuzi(task_id) == -1) {
            $('#pause' + task_id).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">').css('pointer-events', '');
            $('#d_pause' + task_id).html('<img style="width: 15px;" src="/img/blue_begin.png" title ="暂停中" value="1">').css('pointer-events', '');
            // 当子任务是最后一个完成的子任务时，父任务自动完成
            if (zirenwuok(task_id) == '-1') {
                $('#pause' + task_id).html('<img src="/img/kb.png" title ="空白" value="11">');
                $('#zrw' + task_id).html('<img  src="/img/checked.png" title ="已完成" value="1">');
                $('#pause' + task_id).css('pointer-events', 'none');

                $('#d_pause' + task_id).html('<img src="/img/kb.png" title ="空白" value="11">');
                $('#d_zrw' + task_id).html('<img style="width: 32px;" src="/img/checked.png" title ="已完成" value="1">');
                $('#d_pause' + task_id).css('pointer-events', 'none');

                // 任务详情页面下修改删除按钮的隐藏
                d_mo_btn_hide(task_id)
                // 任务下修改删除标识隐藏
                k_mo_btn_hide(task_id)
            }
        }

        if (zhuzi(task_id) == -1) {
            $('#pause' + task_id).html('<img src="/img/blue_begin.png" title ="暂停中" value="1">').css('pointer-events', '');
            $('#d_pause' + task_id).html('<img style="width: 15px;" src="/img/blue_begin.png" title ="暂停中" value="1">').css('pointer-events', '');
            // 当子任务是最后一个完成的子任务时，父任务自动完成
            if (zirenwuok(task_id) == '-1') {
                $('#pause' + task_id).html('<img src="/img/kb.png" title ="空白" value="11">');
                $('#zrw' + task_id).html('<img  src="/img/checked.png" title ="已完成" value="1">');
                $('#pause' + task_id).css('pointer-events', 'none');

                $('#d_pause' + task_id).html('<img src="/img/kb.png" title ="空白" value="11">');
                $('#d_zrw' + task_id).html('<img style="width: 32px;" src="/img/checked.png" title ="已完成" value="1">');
                $('#d_pause' + task_id).css('pointer-events', 'none');

                // 任务详情页面下修改删除按钮的隐藏
                d_mo_btn_hide(task_id)
                // 任务下修改删除标识隐藏
                k_mo_btn_hide(task_id)
            }
        }
    }
</script>

</html>